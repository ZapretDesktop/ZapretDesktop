# ZapretDesktop

<img width="642" height="512" alt="image" src="https://github.com/user-attachments/assets/cfa3edca-cc64-4930-bf25-98c3fd7b7c87" />

**ZapretDesktop** — программа для Windows, которая управляет обходом DPI (глубокой инспекции пакетов) на основе zapret/Flowseal. Через один интерфейс вы выбираете стратегию, запускаете её, тестируете, редактируете списки доменов и обновляете компоненты.

- **Версия:** 1.6.1  
- **Платформа:** Windows 10/11 (64-bit)  
- **Требования:** права администратора, при сборке из исходников — Python 3.10+

---

## Содержание

1. [Быстрый старт](#1-быстрый-старт)
2. [Первый запуск](#2-первый-запуск)
3. [Меню и горячие клавиши](#3-меню-и-горячие-клавиши)
4. [Работа со стратегиями](#4-работа-со-стратегиями)
5. [Тестирование стратегий](#5-тестирование-стратегий)
6. [Редактор списков и файлов](#6-редактор-списков-и-файлов)
7. [Конструктор стратегий и создание bin](#7-конструктор-стратегий-и-создание-bin)
8. [Списки по странам (OONI)](#8-списки-по-странам-ooni)
9. [Дополнения и обновления](#9-дополнения-и-обновления)
10. [Настройки](#10-настройки)
11. [Диагностика](#11-диагностика)
12. [Конфигурация и хранение данных](#12-конфигурация-и-хранение-данных)
13. [Сборка из исходников](#13-сборка-из-исходников)
14. [Частые вопросы и решения](#14-частые-вопросы-и-решения)

---

## 1. Быстрый старт

### Установка готовой сборки

1. Скачайте архив с релизом и распакуйте в любую папку.
2. Убедитесь, что рядом с `ZapretDesktop.exe` есть папка **winws** (с `winws.exe`, списками и `.bat`-стратегиями). Если её нет — скопируйте из исходников или получите через меню «Обновление» → проверка/обновление zapret.
3. Запустите **ZapretDesktop.exe** **от имени администратора** (правый клик → «Запуск от имени администратора»).

Без прав администратора приложение не сможет управлять сетевыми компонентами zapret.

### Запуск из исходников (разработка)

- Установите **Python 3.10+** и добавьте его в PATH.
- В папке проекта выполните:
  ```batch
  pip install -r requirements.txt
  python ZapretDesktop.py
  ```
- Запуск тоже только **от имени администратора**.

---

## 2. Первый запуск

При первом запуске (если в конфиге не отмечено `first_run_done`) открывается **мастер первичной настройки**:

- **Язык программы** — русский или английский.
- **Отображать в трее** — показывать иконку в области уведомлений.
- **Запускать свернутым в трей** — при старте сразу сворачивать окно в трей (доступно при включённом «Отображать в трее»).
- **Запуск с Windows** — добавить ZapretDesktop в автозагрузку (через Планировщик заданий).
- **Закрывать winws при выходе** — при закрытии программы останавливать процесс winws.exe.

После нажатия «ОК» настройки сохраняются, мастер больше не показывается. Рекомендуется зайти в **Настройки** (Ctrl+,) и проверить путь к папке **winws** и репозиторий zapret.

---

## 3. Меню и горячие клавиши

### Меню «Файл» (главное меню слева)

| Пункт | Горячая клавиша | Описание |
|-------|------------------|----------|
| Тестирование | Ctrl+Shift+T | Окно тестирования стратегий (HTTP/TLS/Ping). |
| Диагностика | Ctrl+Shift+D | Окно диагностики системы. |
| Редактор | Ctrl+E | Объединённый редактор (списки, drivers\etc, стратегии). |
| Создать стратегию | Ctrl+N | Конструктор пользовательской стратегии. |
| Создание bin | Ctrl+Shift+B | Диалог создания bin-файла в winws\bin из hex. |
| Открыть папку... | — | Подменю: «Открыть папку winws» (Ctrl+Shift+W), «Открыть папку конфигурации программы» (Ctrl+Shift+O). |
| Свернуть окно | Ctrl+M | Свернуть в трей (если трей включён). |
| Закрыть программу | Ctrl+Q | Выход из приложения. |

### Меню «Настройки»

| Пункт | Горячая клавиша |
|-------|------------------|
| Настройки | Ctrl+, |

### Меню «Дополнения»

| Пункт | Горячая клавиша |
|-------|------------------|
| Дополнения | Ctrl+Shift+A |

### Меню «Обновление»

| Пункт | Горячая клавиша | Описание |
|-------|------------------|----------|
| Проверить обновление программы | Ctrl+F5 | Проверка обновлений ZapretDesktop. |
| Проверить обновление zapret | F5 | Проверка обновлений стратегий zapret из настроенного репозитория. |
| Ручное обновление | Ctrl+Shift+U | Установка из локального ZIP-архива. |
| Обновить IPSet List | — | Обновление ipset-all.txt. |

### Меню «Справка»

| Пункт | Горячая клавиша | Описание |
|-------|------------------|----------|
| Ссылка на репозиторий ZapretDesktop | F1 | Открытие страницы проекта в браузере. |
| Ссылка на Flowseal zapret | Shift+F1 | Открытие репозитория zapret в браузере. |

В главном окне также доступен выпадающий **список стратегий** и подменю со **списком всех стратегий** (быстрый выбор по имени); при выборе стратегии из списка она сохраняется как последняя выбранная.

---

## 4. Работа со стратегиями

### Выбор и запуск

- Стратегии — это **.bat**-файлы в **корне папки winws**. Файл **service.bat** в список стратегий не входит и служебный.
- В главном окне в выпадающем списке выберите нужную стратегию и нажмите **«Запустить»**. Для остановки — **«Остановить»**.
- Перед запуском выполняется проверка: разрешён только запуск .bat из папки winws и только тех имён, которые были загружены в список при открытии окна (защита от path traversal и посторонних скриптов).

### Автозапуск и перезапуск

В настройках:

- **Автозапуск последней стратегии** — при старте ZapretDesktop через ~1 с автоматически запускается последняя выбранная стратегия.
- **Автоперезапуск стратегии** — если процесс winws.exe завершился, а пользователь не нажимал «Остановить», стратегия автоматически перезапускается.

### Автоперезапуск приложений

В настройках (категория «Автоперезапуск приложений») можно задать список **имён процессов** (например, `discord.exe`). При **запуске** стратегии эти процессы сначала завершаются, затем через 0.5 с запускается .bat. Так можно перезапускать клиенты (Discord и др.) вместе с включением обхода DPI.

### Системный трей

- При включённой опции «Отображать в трее» окно можно свернуть в иконку в области уведомлений.
- Меню трея: **Показать/Свернуть** окно, **Сменить стратегию** (подменю со списком стратегий и пунктом «Открыть папку winws»), **Перезапуск** (подменю: перезапуск текущей стратегии), **Выход**.

---

## 5. Тестирование стратегий

Окно тестирования (меню «Файл» → «Тестирование» или Ctrl+Shift+T):

- **Выбор стратегии** — тестировать одну выбранную .bat или все стратегии (кроме service.bat).
- **Тесты:** HTTP (доступность по HTTP/1.1), TLS (проверки TLS 1.2/1.3 по целям), Ping (сетевая достижимость и задержки). При тесте «все стратегии» winws перед каждым набором перезапускается.
- **Цели** задаются в **winws\utils\targets.txt**. Во вкладке **Targets** этого же окна можно редактировать файл (подсветка, автосохранение, предупреждение о несохранённых изменениях).
- **Таблица результатов** — статусы по каждой цели с цветовой индикацией (успех/ошибка).
- **Таблица лучших стратегий** — сводка по стратегиям (рабочие / средние / нерабочие) с возможностью экспорта.
- **Экспорт** — общая таблица и рейтинг стратегий в TXT, CSV или JSON.

---

## 6. Редактор списков и файлов

Объединённый редактор (меню «Файл» → «Редактор» или Ctrl+E) содержит три вкладки.

### Вкладка «Списки» (winws\lists)

- Редактирование доменных списков (list-general.txt, list-exclude.txt, list-google.txt и др.) и IPSet (ipset-all.txt, ipset-exclude.txt и др.).
- Слева — список файлов с **фильтром по имени**; при отсутствии совпадений отображается «Ничего не найдено».
- Подсветка синтаксиса, нумерация строк, автосохранение с задержкой, обновление при изменении файла извне.
- Контекстное меню списка файлов: открыть папку в проводнике, создать файл (для списков и стратегий), удалить файл (с подтверждением).

### Вкладка «drivers\etc»

- Редактирование файлов из `C:\Windows\System32\drivers\etc` (hosts, services и др.).
- Параллельный просмотр **zapret_hosts.txt** (из winws).

### Вкладка «Стратегии»

- Редактирование **.bat**-файлов стратегий с подсветкой синтаксиса.
- Встроенная **консоль cmd.exe** в папке winws: интерактивный ввод команд в окружении winws. Консоль можно запускать/останавливать; вывод отображается в той же вкладке.

### Общие возможности редактора

- **Меню «Файл»:** создать файл (Ctrl+N), сохранить (Ctrl+S), сохранить как (Ctrl+Shift+S), открыть папку в cmd/PowerShell (текущая вкладка или папка текущего файла), закрыть окно (Ctrl+W).
- **Меню «Правка»:** поиск и замена в текущем файле, поиск по файлам текущей вкладки.
- **Поиск и замена:** отдельное окно (не модальное): поле поиска, поле замены, «с учётом регистра», «целое слово», «Найти далее», «Найти предыдущий», «Заменить», «Заменить все».
- **Поиск по файлам:** диалог с масками (например *.txt, *.bat), опция «с учётом регистра». Результаты в виде «файл:строка: фрагмент»; двойной клик — переход к строке в редакторе.
- **Строка состояния:** хлебные крошки (путь к текущему файлу, клик — переход к строке), размер табуляции (Spaces: 2 / 4 / 8, Tabs), кодировка (UTF-8, UTF-8 BOM, Windows-1251), окончания строк (CRLF, LF, CR).
- **Масштаб** — через меню «Вид» (увеличение/уменьшение шрифта).
- **Конвертирование** — меню для смены кодировки/окончаний строк текущего файла.
- **Автодополнение** — в текстовых полях редактора при вводе могут предлагаться варианты из текущего файла/списков.
- **Отдельные окна** «Редактор списков» и «Редактор drivers\etc» доступны из меню для быстрого доступа без переключения вкладок.

Для редактирования **hosts** и обновления **zapret_hosts** может потребоваться запуск от имени администратора.

---

## 7. Конструктор стратегий и создание bin

### Конструктор стратегий (Ctrl+N)

Визуальный мастер создания новой .bat-стратегии в папке winws.

- **Имя стратегии** — имя без расширения (будет создан файл `Имя.bat`).
- **Использовать Game Filter** — галочка; при включении в .bat добавляется вызов загрузки Game Filter и учёт портов игрового фильтра в Windows Firewall.

**Вкладка «Фильтры трафика»:**

- TCP-порты (например 80,443).
- UDP-порты (например 443,19294-19344).
- L7-протоколы (например discord, stun).
- L3-протоколы (например ipv4).

**Вкладка «Списки»:**

- **Списки доменов:** Hostlist, Hostlist exclude, Hostlist domains (из файлов в winws\lists).
- **IPSet:** IPSet, IPSet exclude (файлы из winws\lists).

**Вкладка «DPI Desync»:**

- DPI Desync: fake, multisplit, syndata, multidisorder.
- Repeats (1–20).
- Fake QUIC, Fake TLS, Fake TLS mod — выбор бинарников из winws\bin.
- Fooling (например ts).
- Split seqovl, Split pos, Split pattern.
- AutoTTL, Any protocol.
- Fake unknown UDP, Cutoff (n2, n3) — при необходимости выбор бинарников.
- **IP ID** — например zero.

В сгенерированный .bat добавляются вызовы service.bat, при необходимости загрузка Game Filter, переменные BIN/LISTS, параметры **--wf-tcp** и **--wf-udp** для Windows Firewall (порты из правил и при включённом Game Filter — %GameFilter%).

### Создание bin (Ctrl+Shift+B)

Диалог **«Создание bin»**:

- **Имя файла** в winws\bin (например имя модуля).
- **Hex-содержимое** — текст в виде шестнадцатеричных символов (пробелы/переносы игнорируются).
- По кнопке создания в winws\bin записывается бинарный файл с указанным именем. Нужны права на запись в папку winws\bin.

---

## 8. Списки по странам (OONI)

На основе данных **OONI** (Open Observatory of Network Interference) можно сформировать список доменов по стране и сохранить его в winws\lists.

- Доступ из редактора списков или через соответствующий пункт меню/диалог **«Список по странам»** (или аналог по переводу).
- **Страна** — выбор из списка (Россия, Беларусь, Казахстан, Узбекистан, Туркменистан, Таджикистан, Киргизия, Китай, Иран, Турция, Египет, Вьетнам, Мьянма, Пакистан, Индия, ОАЭ, Саудовская Аравия, Таиланд, Индонезия, Малайзия и др. по коду ISO).
- **Имя файла** — например list-ru.txt (подсказка подставляется по выбранной стране).
- **Только подтверждённые блокировки** — галочка для ограничения выборки подтверждёнными блокировками (повышает качество списка).
- **Лимит доменов** — от 100 до 5000 (по умолчанию 500).
- После загрузки данные сохраняются в выбранный файл в папке winws\lists. Требуется доступ к API OONI (сеть).

---

## 9. Дополнения и обновления

### Обновление ZapretDesktop

- Меню «Обновление» → «Проверить обновление программы» (Ctrl+F5). При наличии новой версии предлагается скачать и установить её.

### Обновление zapret (стратегии из GitHub)

- Меню «Обновление» → «Проверить обновление zapret» (F5). Используется репозиторий из настроек (по умолчанию `Flowseal/zapret-discord-youtube`). Перед обновлением программа предлагает остановить winws; создаётся резервная копия папки winws.

### Ручное обновление (локальный ZIP)

- Меню «Обновление» → пункт ручного обновления (Ctrl+Shift+U). Выбор локального ZIP-архива; распаковка и слияние с текущей папкой winws (по правилам, заданным в программе).

### Окно «Дополнения» (Ctrl+Shift+A)

- **Таблица:** столбцы «Название», «URL», кнопки «Скачать» и «Открыть» для каждой строки.
- Строки можно **редактировать** (двойной клик по ячейке), **добавлять** и **удалять**. Список дополнений хранится в конфиге (`addons`) и подгружается при следующем запуске. По умолчанию может быть одна строка (например Flowseal zapret-discord-youtube).
- **Режим установки** (перед скачиванием): полная установка, только списки (lists), только стратегии (winws), только бинарники (bin).
- **Поиск** по таблице — фильтрация по названию/URL; при отсутствии совпадений отображается служебная строка «Ничего не найдено».
- **Скачать** — скачивание выбранного релиза/архива по URL и установка в winws согласно выбранному режиму. **Открыть** — открытие ссылки в браузере.

### Прочее

- **Обновить IPSet List** — обновление файла ipset-all.txt (из настроенного источника/репозитория).
- Обновление/проверка **hosts**-файла доступна через редактор drivers\etc и связанные пункты.

### Флаг /B и проверка обновлений zapret в стратегиях

- В настройках (категория «Добавление команды /B»): **Добавить /B во все стратегии** и **Удалить /B из всех стратегий** — кнопки для массового изменения .bat в папке winws. **Добавлять /B при обновлении** — автоматически добавлять /B при обновлении zapret.
- В настройках (категория «Обновление»): **Удалять проверку обновлений zapret из стратегий** — при включении из всех .bat удаляются строки вида `call service.bat check_updates`. Это сохраняется в конфиге (`remove_check_updates`).

---

## 10. Настройки

Открываются через меню «Настройки» или Ctrl+,. Слева — **список категорий** с **поиском** (фильтрация по названию категории); при отсутствии совпадений показывается «Ничего не найдено». Справа — страница выбранной категории.

| Категория | Параметры |
|-----------|-----------|
| **Язык программы** | Выбор языка: русский / English. После смены языка может потребоваться перезапуск приложения. |
| **Путь к winws** | Путь к папке winws. Пусто = папка рядом с исполняемым файлом. Кнопка «Обзор» для выбора папки. |
| **Трей** | Отображать в трее; Запускать свернутым в трей (доступно при включённом отображении в трее). |
| **Поведение при выходе** | Закрывать winws при выходе из программы. |
| **Автозапуск** | Запуск с Windows (Планировщик заданий); Автозапуск последней стратегии при старте; Автоперезапуск стратегии при сбое. |
| **Фильтры** | Game Filter (вкл/выкл); IPSet Filter: Loaded / None / Any. Изменения фильтров применяются к файлам в winws и могут потребовать перезапуска стратегии. |
| **Автоперезапуск приложений** | Таблица с именами процессов (например discord.exe). Кнопки «Добавить», «Удалить». При запуске стратегии эти процессы завершаются, затем запускается .bat. |
| **Добавление команды /B** | Добавлять /B при обновлении zapret; кнопки «Добавить /B во все стратегии», «Удалить /B из всех стратегий». |
| **Обновление** | Удалять проверку обновлений zapret из стратегий; поле «Репозиторий zapret» (GitHub owner/repo или полная ссылка). |

Настройки сохраняются в `%APPDATA%\Roaming\ZapretDesktop\config.json` при нажатии «ОК». Перед сохранением создаётся резервная копия `config.json.bak`. Автозапуск с Windows управляется через отдельный механизм (Планировщик заданий).

---

## 11. Диагностика

Окно диагностики (меню «Файл» → «Диагностика» или Ctrl+Shift+D) выполняет последовательность проверок и выводит результат в текстовое поле. В окне доступно меню **«Экспорт»**: сохранить отчёт в TXT, CSV или JSON (с датой/временем в имени файла по умолчанию).

Проверки (кратко):

1. **Base Filtering Engine (BFE)** — служба должна быть запущена (RUNNING); необходима для работы zapret.
2. **Системный прокси** — если включён, выводится предупреждение с адресом прокси и рекомендацией проверить настройки.
3. **TCP timestamps** — проверка и при необходимости автоматическое включение (netsh interface tcp set global timestamps=enabled).
4. **Adguard** — наличие процесса AdguardSvc.exe (конфликт с Discord); при обнаружении выводится ссылка на issue.
5. **Killer** — наличие служб Killer (конфликт); при обнаружении выводится ссылка.
6. **Intel Connectivity Network Service** — конфликт; при обнаружении выводится ссылка.
7. **Check Point** — службы TracSrvWrapper/EPWD; рекомендация удалить при конфликте.
8. **SmartByte** — наличие службы SmartByte; рекомендация удалить при конфликте.
9. **WinDivert64.sys** — наличие .sys файлов в winws\bin.
10. **VPN** — наличие служб с «VPN» в имени; предупреждение о возможном конфликте.
11. **Защищённый DNS (DoH)** — проверка через реестр; при отсутствии DoH выводятся рекомендации по настройке DNS (в т.ч. для Windows 11).
12. **Конфликт WinDivert** — если winws не запущен, но служба WinDivert в состоянии RUNNING/STOP_PENDING, предпринимается попытка остановить и удалить службу.
13. **Служба Zapret** — статус службы zapret (установлена/запущена/остановлена); при запущенной службе может выводиться путь к стратегии из реестра.
14. **winws.exe** — запущен ли процесс, выводится PID.
15. **Версия Windows** — release, version, архитектура (platform).
16. **Права администратора** — проверка IsUserAnAdmin().
17. **Стратегии** — наличие папки winws\strategies и количество .bat в ней (в зависимости от сборки стратегии могут находиться в корне winws; диагностика проверяет подпапку strategies).
18. **DNS-серверы** — вывод до 3 DNS из ipconfig /all.
19. **Сетевые адаптеры** — количество адаптеров по выводу ipconfig.
20. **targets.txt** — наличие winws\utils\targets.txt и количество непустых строк.
21. **hosts** — наличие C:\Windows\System32\drivers\etc\hosts и количество записей (не комментариев).

Цветовая индикация в отчёте: зелёный — успех, красный — ошибка, оранжевый — предупреждение/неопределённость.

---

## 12. Конфигурация и хранение данных

- **Файл конфигурации:** `%APPDATA%\Roaming\ZapretDesktop\config.json`.
- **Резервная копия:** перед каждым сохранением создаётся `config.json.bak` в той же папке.
- **Структура конфига:**
  - **app** — настройки приложения (все параметры из диалога настроек: language, show_in_tray, start_minimized, close_winws_on_exit, auto_start_last_strategy, auto_restart_strategy, add_b_flag_on_update, remove_check_updates, last_strategy, winws_path, zapret_repo, game_filter_enabled, ipset_filter_mode, auto_restart_apps, first_run_done и т.д.).
  - **zapret_version** — объект с полем version (версия zapret, с которой работало приложение).
  - **addons** (при наличии) — массив записей {name, url} для окна «Дополнения».
- При повреждении config.json программа может попытаться загрузить настройки из config.json.bak. Старые форматы (плоский config или отдельные app.json / zapret_version.json в папке программы) при первом запуске мигрируются в новый формат в AppData.

---

## 13. Сборка из исходников

### Требования

- Windows 10/11 (64-bit)
- Python 3.10+
- Права на запись в папку проекта

### Зависимости

- Указаны в `requirements.txt`: PyQt6 (≥6.4), psutil (≥5.9), requests (≥2.28), pywinstyles (≥1.0). Для сборки exe дополнительно нужен PyInstaller.

### Сборка одним скриптом

В корне проекта выполните:

```batch
build.bat
```

Скрипт:

1. Проверяет наличие Python в PATH.
2. Устанавливает зависимости из `requirements.txt` и PyInstaller.
3. Удаляет каталоги `build` и `dist` при их наличии.
4. Запускает PyInstaller с параметрами: один файл, без консоли, имя ZapretDesktop, иконка icon.ico, скрытые импорты pywinstyles и PyQt6.QtSvg, без UPX.
5. Если в проекте есть папка **winws**, копирует её в `dist\winws`.

Результат: **dist\ZapretDesktop.exe**. Рядом должна лежать папка **winws** (скопирована скриптом, если была в проекте).

### Ручная сборка

```batch
pip install -r requirements.txt
pip install pyinstaller
pyinstaller --noconfirm --onefile --windowed --name ZapretDesktop --icon icon.ico --hidden-import pywinstyles --hidden-import PyQt6.QtSvg --noupx ZapretDesktop.py
```

Исполняемый файл появится в **dist\ZapretDesktop.exe**. Папку **winws** при необходимости скопируйте в `dist\` вручную.

---

## 14. Частые вопросы и решения

**Программа не запускается / просит права администратора**  
Запускайте ZapretDesktop всегда **от имени администратора** (правый клик по exe → «Запуск от имени администратора»).

**Нет стратегий в списке**  
Проверьте, что папка **winws** лежит рядом с exe (или путь к ней указан в настройках) и в ней есть **.bat**-файлы (кроме service.bat). После добавления .bat в папку обновите список (перезапуск приложения или повторное открытие главного окна).

**Стратегия не запускается / падает**  
Откройте **Диагностику** (Ctrl+Shift+D), проверьте сообщения: BFE, драйвер WinDivert, конфликты (Adguard, Killer, Intel, Check Point, SmartByte), VPN, DNS. Убедитесь, что в **winws\bin** есть **winws.exe** и нужные модули; при необходимости обновите zapret через меню «Обновление».

**Нужно добавить домены только для одной страны**  
Используйте функцию **списков по странам (OONI)**: выберите страну, лимит доменов, при необходимости «только подтверждённые блокировки», укажите имя файла и сохраните в winws\lists.

**Где хранятся настройки?**  
В `%APPDATA%\Roaming\ZapretDesktop\config.json`. Резервная копия — `config.json.bak`. Папку конфигурации можно открыть через меню «Файл» → «Открыть папку» → «Открыть папку конфигурации программы» (Ctrl+Shift+O).

**Нужен свой репозиторий стратегий**  
В настройках в категории «Обновление» укажите репозиторий zapret (GitHub `owner/repo` или полную ссылку) — проверка и обновление будут идти из него.

**После смены языка интерфейс не полностью переключился**  
Перезапустите ZapretDesktop после сохранения настроек с новым языком.

**Редактор не может сохранить hosts**  
Редактирование файлов в `C:\Windows\System32\drivers\etc` требует прав администратора. Запустите ZapretDesktop от имени администратора.

---

## Ссылки и контакты

- Репозиторий ZapretDesktop и ссылка на zapret/Flowseal — в меню **«Справка»** (F1, Shift+F1) в приложении.
- OONI (api.ooni.io) — данные для генерации списков по странам.
- **E-mail:** ZapretDesktop@proton.me

---

 