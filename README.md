# ZapretDesktop
<img width="642" height="512" alt="image" src="https://github.com/user-attachments/assets/42f0fa08-00cd-4883-80b4-9ad0f7791bfa" />


## 1. Обзор продукта

ZapretDesktop — приложение для Windows, обеспечивающее централизованное управление решениями обхода глубокой инспекции пакетов (DPI) на базе zapret/Flowseal. Продукт предоставляет единую точку контроля над стратегиями перехвата трафика, диагностикой сетевой среды и поддержкой актуальности компонентов.

**Версия:** 1.6.0
**Целевая платформа:** Windows 10/11 (x64)  
**Требования:** права администратора, Python 3.10+ (для сборки из исходников)

---

## 2. Архитектура решения

### 2.1. Технологический стек

| Компонент | Назначение |
|-----------|------------|
| Python 3.10+ | Ядро приложения |
| PyQt6 6.4+ | Графический интерфейс |
| psutil 5.9+ | Мониторинг процессов и системных служб |
| requests 2.28+ | Сетевые запросы (обновления, OONI) |
| pywinstyles 1.0+ | Интеграция с оформлением окна Windows |
| PyInstaller | Сборка автономного исполняемого файла |

### 2.2. Структура проекта

```
ZapretDesktop/
├── main.py                    # Точка входа, проверка прав, инициализация
├── build.bat                  # Скрипт сборки (PyInstaller)
├── requirements.txt
├── src/
│   ├── core/                  # Ядро и служебные модули
│   │   ├── config_manager.py      # Управление конфигурацией (AppData)
│   │   ├── path_utils.py          # Работа с путями приложения и winws
│   │   ├── translator.py          # Локализация (русский/английский)
│   │   ├── embedded_assets.py     # Встроенные иконки
│   │   ├── embedded_style.py      # Стиль интерфейса
│   │   ├── autostart_manager.py   # Автозапуск с Windows
│   │   ├── app_updater.py         # Обновление ZapretDesktop
│   │   ├── zapret_updater.py      # Обновление zapret/Flowseal и ZIP-дополнений
│   │   ├── winws_manager.py       # Управление списками, фильтрами, IPSet
│   │   ├── bat_generator.py       # Генерация .bat-стратегий
│   │   └── window_styles.py       # Безопасное применение pywinstyles ко всем окнам
│   ├── ui/                    # Главное окно и базовые окна
│   │   ├── main_window.py         # Главное окно (выбор стратегии, запуск/остановка, диагностика)
│   │   ├── standard_window.py     # Базовое окно с системной рамкой
│   │   ├── standard_dialog.py     # Базовый диалог
│   │   ├── system_tray.py         # Иконка и меню в системном трее
│   │   ├── test_window.py         # Тестирование стратегий (HTTP/TLS/Ping, рейтинг)
│   │   └── message_box_utils.py   # Единое оформление системных сообщений
│   ├── dialogs/               # Диалоговые окна
│   │   ├── settings_dialog.py      # Диалог настроек
│   │   ├── first_run_window.py     # Мастер первичной настройки
│   │   ├── vs_update_dialog.py     # Диалог прогресса обновления
│   │   ├── find_replace_dialog.py  # Поиск и замена в редакторе
│   │   ├── find_in_files_dialog.py # Поиск по файлам в текущей папке
│   │   ├── bin_creator_dialog.py   # Создание bin-файлов
│   │   ├── country_blocklist_dialog.py # Генерация списков по странам (OONI)
│   │   ├── addons_dialog.py        # Окно «Дополнения» (списки GitHub-ресурсов)
│   │   └── strategy_creator_window.py  # Конструктор пользовательских стратегий
│   ├── editor/                # Объединённый и отдельные редакторы
│   │   ├── unified_editor_window.py   # Вкладки: lists, drivers\etc, стратегии + встроенный cmd
│   │   ├── lists_editor_window.py     # Отдельный редактор winws\lists
│   │   ├── etcdrivers_editor_window.py# Отдельный редактор C:\Windows\System32\drivers\etc
│   │   ├── line_number_editor.py      # QPlainTextEdit с нумерацией строк
│   │   ├── editor_highlighters.py     # Подсветка синтаксиса
│   │   └── editor_autocomplete.py     # Автодополнение
│   └── widgets/               # Кастомные виджеты
│       ├── style_menu.py              # Меню в стиле VS Code
│       ├── custom_combobox.py         # Кастомный ComboBox
│       ├── custom_checkbox.py         # Кастомный CheckBox
│       ├── custom_context_widgets.py  # QLineEdit/QTextEdit/QPlainTextEdit с контекстным меню
│       ├── custom_scrollbar.py        # Кастомные скроллбары
│       ├── custom_overlay_scrollbar.py# Оверлейные скроллбары
│       ├── animated_progressbar.py    # Анимированный прогрессбар
│       ├── breadcrumb_widget.py       # «Хлебные крошки»
│       └── label_menu_widget.py       # QLabel с выпадающим меню
└── winws/                     # Среда выполнения zapret/Flowseal
    ├── bin/                   # winws.exe, бинарные модули
    ├── lists/                 # Списки доменов, IPSet
    ├── utils/                 # Скрипты, targets.txt
    └── *.bat                  # .bat-стратегии в корне winws
```

### 2.3. Хранение конфигурации

Конфигурация хранится в `%APPDATA%\Roaming\ZapretDesktop\config.json`. Структура:

- **app** — настройки приложения (язык, трей, пути, фильтры, автозапуск)
- **zapret_version** — версия zapret/Flowseal

Перед каждым сохранением создаётся резервная копия `config.json.bak`.

---

## 3. Функциональные возможности

### 3.1. Управление стратегиями

- **Выбор стратегии** — выбор .bat-файла из папки winws через выпадающий список
- **Запуск/остановка** — управление процессом winws.exe
- **Проверка безопасности** — разрешён запуск только .bat из папки winws; список стратегий проверяется перед выполнением
- **Автозапуск последней стратегии** — опциональный запуск при старте приложения
- **Автоперезапуск стратегии** — перезапуск при сбое процесса

### 3.2. Тестирование стратегий

Модуль тестирования позволяет подробно оценить эффективность стратегий до развёртывания:

- **HTTP/TLS‑тесты** — проверка доступности целей по HTTP/1.1 и отдельные проверки TLS 1.2/1.3 для каждой цели
- **Ping‑тесты** — параллельная проверка сетевой достижимости с разбором среднего времени ответа (ms)
- **Выбор стратегии** — тестирование одной выбранной `.bat` или всех стратегий (кроме служебных), с автоматическим перезапуском winws
- **Таблица результатов** — детальные статусы HTTP/TLS/Ping по каждой цели с цветовой индикацией
- **Таблица лучших стратегий** — агрегация статистики по стратегиям с цветовой классификацией (рабочие / средние / нерабочие)
- **Экспорт** — выгрузка как общей таблицы, так и рейтинга стратегий в TXT, CSV, JSON
- **Управление целями** — встроенная вкладка `Targets` с редактированием `targets.txt` (подсветка, автосохранение, автообновление при внешних изменениях)

### 3.3. Конструктор стратегий

Визуальный мастер создания пользовательских стратегий с настройкой:

**Фильтры трафика:**
- TCP-порты, UDP-порты
- L7-протоколы, L3-протоколы
- Game Filter (опционально)

**Списки доменов:**
- Hostlist, Hostlist exclude, Hostlist domains

**IPSet-списки:**
- IPSet, IPSet exclude

**DPI Desync-методы:**
- DPI Desync, Repeats
- Fake QUIC, Fake TLS, Fake TLS mod
- Fooling, Split seqovl, Split pos, Split pattern
- AutoTTL, Any protocol, Fake unknown UDP, Cutoff

**Дополнительные параметры:**
- IP ID
- Интеграция с Windows Firewall (--wf-tcp, --wf-udp)

### 3.4. Объединённый редактор (списки / drivers\\etc / стратегии)

- **Редактирование доменных списков** — list-general.txt, list-exclude.txt, list-google.txt и др.
- **Редактирование IPSet‑списков** — ipset-all.txt, ipset-exclude.txt и дополнительные файлы
- **Редактирование файлов drivers\\etc** — `C:\Windows\System32\drivers\etc\hosts`, services и др., с параллельным просмотром zapret_hosts.txt
- **Редактирование .bat‑стратегий** — отдельная вкладка «Стратегии» с подсветкой синтаксиса
- **Встроенная консоль cmd.exe** — интерактивная консоль во вкладке «Стратегии» (запуск команд в папке winws)
- **Поиск и замена** — с учётом регистра и целых слов в текущем файле
- **Поиск по файлам** — отдельный диалог поиска по всем файлам текущей вкладки (lists / etc / .bat) с переходом по двойному клику
- **Фильтрация списка файлов** — строка поиска по имени файла с состоянием «ничего не найдено»
- **Автосохранение и слежение за изменениями** — автоматическое сохранение с debounce‑таймером и обновление при внешних изменениях файлов
- **Отдельные окна редакторов** — «Редактор списков» (winws\\lists) и «Редактор drivers\\etc» с теми же возможностями, если нужен быстрый доступ по отдельности

### 3.5. Генерация списков по странам

На основе данных OONI (Open Observatory of Network Interference):

- Выбор страны
- Ограничение количества доменов
- Режим «только подтверждённые блокировки» для повышения качества списка
- Сохранение в указанный файл

### 3.6. Фильтры

**Game Filter** — фильтрация игрового трафика (вкл/выкл через настройки). Требует перезапуска zapret для применения.

**IPSet Filter** — три режима:
- **Loaded** — использование загруженного списка ipset-all.txt
- **None** — отключение IPSet
- **Any** — обработка любого трафика

### 3.7. Управление флагом /B

- Добавление /B во все стратегии
- Удаление /B из всех стратегий
- Опция автоматического добавления /B при обновлении zapret
- Удаление проверки обновлений zapret из стратегий (опционально)

### 3.8. Обновления

- **ZapretDesktop** — проверка и установка обновлений приложения
- **zapret (настраиваемый GitHub‑репозиторий)** — обновление стратегий из выбранного репозитория (по умолчанию `Flowseal/zapret-discord-youtube`) с резервной копией папки winws
- **Дополнения (ZIP‑пакеты)** — развёртывание архивов с дополнительными стратегиями/списками/бинарниками через окно «Дополнения» с безопасным слиянием в существующую winws и выбором режима установки (полная, только lists, только strategies, только bin)
- **Ручное обновление** — установка основной поставки из локального ZIP-архива
- **IPSet List** — обновление ipset-all.txt
- **Hosts File** — проверка и обновление hosts-файла

Перед обновлением zapret приложение предлагает остановить запущенный winws.exe.

### 3.9. Диагностика системы

Комплексная проверка окружения перед и во время работы:

| Проверка | Описание |
|----------|----------|
| Base Filtering Engine | Обязательная служба для работы zapret |
| Системный прокси | Предупреждение при включённом прокси |
| TCP timestamps | Проверка и автоматическое включение при необходимости |
| Adguard | Конфликт с Discord |
| Killer | Конфликт со службами Killer |
| Intel Connectivity | Конфликт с Intel Connectivity Network Service |
| Check Point | Конфликт |
| SmartByte | Конфликт |
| WinDivert64.sys | Наличие и конфликты драйвера |
| VPN | Предупреждение о возможных конфликтах |
| Защищённый DNS | Рекомендации по настройке |
| Служба Zapret | Статус службы (если установлена) |
| winws.exe | Процесс и PID |
| Windows | Версия и сборка |
| Права администратора | Подтверждение |
| Стратегии | Наличие .bat-файлов |
| DNS-серверы | Текущая конфигурация |
| Сетевые адаптеры | Количество |
| targets.txt | Наличие и количество целей |
| hosts | Наличие и количество записей |

Результаты диагностики экспортируются в TXT, CSV или JSON.

### 3.10. Системный трей

- Сворачивание в трей
- Быстрый доступ: показать/скрыть окно
- Смена стратегии без открытия главного окна
- Перезапуск стратегии
- Выход из приложения

### 3.11. Настройки

- **Язык** — русский / английский
- **Ссылка на папку winws** — путь к папке winws (пусто = рядом с программой)
- **Репозиторий zapret (GitHub)** — slug `owner/repo` или полная ссылка для проверки/обновления стратегий
- **Трей** — отображение в трее, запуск свернутым
- **Поведение при выходе** — закрытие winws при выходе
- **Автозапуск** — запуск с Windows, автозапуск последней стратегии, автоперезапуск стратегии
- **Фильтры** — Game Filter, IPSet Filter
- **Флаг /B** — добавление при обновлении, удаление проверки обновлений zapret

### 3.12. Мастер первичной настройки

При первом запуске отображается окно с выбором языка и основных опций. При необходимости — включение автозапуска с Windows.

### 3.13. Окно «Дополнения»

- **Таблица дополнений** — настраиваемый список GitHub‑репозиториев и релизов с наборами списков и стратегий
- **Скачивание** — кнопка «Скачать» для передачи ссылки в основное окно и автоматического развёртывания ZIP‑архива в папку winws с учётом выбранного режима установки
- **Открытие ссылок** — кнопка «Открыть» запускает браузер с выбранным репозиторием/релизом
- **Хранение в конфиге** — все строки таблицы сохраняются в `config.json` и подгружаются при следующем запуске
- **Режимы установки** — `Полная установка`, `Установка списков (lists)`, `Установка стратегий (winws)`, `Установка бинарников (bin)`
- **Поиск по списку** — строка поиска по названию/ссылке с отображением служебной строки «Ничего не найдено» при отсутствии совпадений

### 3.14. Поиск по файлам

- **Область поиска** — текущая вкладка редактора (списки, drivers\\etc или стратегии)
- **Маски файлов** — поддержка масок `*.txt`, `*.bat` и списка конкретных имён (для drivers\\etc)
- **Результаты** — список совпадений «файл:строка: фрагмент» с двойным кликом для перехода к нужной строке
- **Регистрозависимость** — опция «с учётом регистра» для точного поиска

---

## 4. Требования к системе

- **ОС:** Windows 10/11 (64-bit)
- **Права:** администратор
- **Сеть:** доступ к GitHub для обновлений и OONI для генерации списков

---

## 5. Установка и запуск

### 5.1. Готовый исполняемый файл

1. Распакуйте архив в папку
2. Убедитесь, что папка `winws` находится рядом с `ZapretDesktop.exe`
3. Запустите `ZapretDesktop.exe` от имени администратора

### 5.2. Сборка из исходников

```batch
# Установка зависимостей
pip install -r requirements.txt
pip install pyinstaller

# Сборка (build.bat)
pyinstaller --noconfirm --onefile --windowed --name ZapretDesktop --icon icon.ico ^
  --hidden-import pywinstyles --hidden-import PyQt6.QtSvg --noupx ZapretDesktop.py

# Результат: dist\ZapretDesktop.exe
```

### 5.3. Запуск в режиме разработки

```batch
python ZapretDesktop.py
```

Требуется Python 3.10+ и права администратора.

---

## 6. Ссылки

- **ZapretDesktop:** репозиторий приложения (см. меню «Справка»)
- **Flowseal zapret:** репозиторий zapret (см. меню «Справка»)
- **OONI:** данные для генерации списков по странам

---

## 7. Контакты

**ZapretDesktop E-mail**  
E-mail: ZapretDesktop@proton.me

---

 
